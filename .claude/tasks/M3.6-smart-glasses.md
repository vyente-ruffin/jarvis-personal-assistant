# M3.6 - Smart Glasses Validation

## Task Description

**What**: Testing vision API with actual Rokid glasses hardware.

**Why**:
- Real hardware has latency, resolution, and format differences
- Integration issues only appear with real devices
- Validates the intended use case actually works

## TDD Requirements

### Test File: `tests/test_glasses.py`

Write these tests FIRST (require actual Rokid glasses hardware):

```python
import pytest
import os
import time
import io

GLASSES_AVAILABLE = os.environ.get("ROKID_GLASSES_CONNECTED") == "true"

@pytest.mark.skipif(not GLASSES_AVAILABLE, reason="Rokid glasses not connected")
@pytest.mark.hardware
def test_glasses_image_capture():
    """Image captured from glasses can be processed."""
    # This would use Rokid SDK to capture
    from app.hardware.rokid import RokidCapture

    capture = RokidCapture()
    image = capture.get_frame()

    assert image is not None
    assert len(image) > 0  # Has data

@pytest.mark.skipif(not GLASSES_AVAILABLE, reason="Rokid glasses not connected")
@pytest.mark.hardware
def test_glasses_image_format():
    """Glasses image format is compatible with vision API."""
    from app.hardware.rokid import RokidCapture
    from PIL import Image

    capture = RokidCapture()
    image_bytes = capture.get_frame()

    # Should be valid image
    image = Image.open(io.BytesIO(image_bytes))
    assert image.format in ["JPEG", "PNG"]
    assert image.size[0] > 0 and image.size[1] > 0

@pytest.mark.skipif(not GLASSES_AVAILABLE, reason="Rokid glasses not connected")
@pytest.mark.hardware
def test_glasses_to_vision_api_roundtrip():
    """Complete flow: capture → API → response."""
    from app.hardware.rokid import RokidCapture
    from fastapi.testclient import TestClient
    from app.main import app

    capture = RokidCapture()
    image_bytes = capture.get_frame()

    client = TestClient(app)

    start = time.time()
    response = client.post(
        "/api/vision/analyze",
        files={"image": ("glasses.jpg", image_bytes, "image/jpeg")},
        data={"prompt": "What do you see?"}
    )
    elapsed = time.time() - start

    assert response.status_code == 200
    assert "analysis" in response.json()
    # Should be fast enough for real-time use
    assert elapsed < 3.0, f"Too slow for glasses: {elapsed:.2f}s"

@pytest.mark.hardware
def test_glasses_audio_output():
    """Response can be played through glasses speakers."""
    # This would use Rokid audio SDK
    pytest.skip("Requires Rokid audio SDK integration")
```

## Verification Command

```bash
ROKID_GLASSES_CONNECTED=true pytest tests/test_glasses.py -v -m hardware
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M3.6 COMPLETE</promise>
```

## Dependencies

- M3.1 (Vision API)

## Files to Create/Modify

- `backend/app/hardware/rokid.py` - RokidCapture class
- `tests/test_glasses.py`
