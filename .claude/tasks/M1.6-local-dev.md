# M1.6 - Local Development Environment

## Task Description

**What**: Configuration that runs the complete system on a developer's machine.

**Why**:
- Fast iteration during development (no deploy cycle)
- Debugging is easier locally
- Works offline (except for AI API calls)

## TDD Requirements

### Test File: `tests/test_local_dev.py`

Write these tests FIRST:

```python
import subprocess
import time
import requests
import pytest
from pathlib import Path

def test_docker_compose_file_valid():
    """docker-compose.yml is valid YAML."""
    result = subprocess.run(
        ["docker", "compose", "config", "--quiet"],
        capture_output=True, text=True
    )
    assert result.returncode == 0, f"Invalid compose file: {result.stderr}"

def test_env_example_exists():
    """Environment example file exists with required vars."""
    with open(".env.example") as f:
        content = f.read()

    required_vars = [
        "GEMINI_API_KEY",
        "MEM0_API_URL",
        "USER_ID"
    ]
    for var in required_vars:
        assert var in content, f"Missing {var} in .env.example"

def test_backend_starts_standalone():
    """Backend can start without Docker."""
    # This test assumes backend is started separately
    # Try to reach health endpoint
    try:
        response = requests.get("http://localhost:8000/health", timeout=5)
        assert response.status_code == 200
    except requests.exceptions.ConnectionError:
        pytest.skip("Backend not running - start with: uvicorn app.main:app")

def test_frontend_dev_server_starts():
    """Frontend dev server can start."""
    # This test assumes frontend is started separately
    try:
        response = requests.get("http://localhost:5173", timeout=5)
        assert response.status_code == 200
    except requests.exceptions.ConnectionError:
        pytest.skip("Frontend not running - start with: npm run dev")

@pytest.mark.slow
def test_docker_compose_up_succeeds():
    """docker-compose up starts all services."""
    # Start services
    subprocess.run(
        ["docker", "compose", "up", "-d"],
        check=True, timeout=120
    )

    # Wait for services
    time.sleep(10)

    try:
        # Check backend health
        response = requests.get("http://localhost:8000/health", timeout=10)
        assert response.status_code == 200

        # Check frontend
        response = requests.get("http://localhost:5173", timeout=10)
        assert response.status_code == 200
    finally:
        # Cleanup
        subprocess.run(["docker", "compose", "down"], check=True)
```

## Verification Command

```bash
pytest tests/test_local_dev.py -v -m "not slow"
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M1.6 COMPLETE</promise>
```

## Dependencies

- M1.1 (Project Structure) - can run in parallel with M1.2-M1.5

## Files to Create/Modify

- `docker-compose.yml`
- `.env.example`
- `tests/test_local_dev.py`
