# M1.4 - Memory Integration

## Task Description

**What**: Connection to Mem0 API for storing and retrieving semantic memories.

**Why**:
- This is what differentiates JARVIS from every other voice assistant
- Memory must persist across sessions, devices, and time
- Semantic search finds relevant memories even with different wording

## TDD Requirements

### Test File: `tests/test_memory.py`

Write these tests FIRST (based on Mem0 API documentation):
Mem0 operations: add(), search(), get(), update(), delete()

```python
import pytest
from app.core.memory_client import MemoryClient

@pytest.fixture
def memory_client():
    """In-memory Mem0 client for testing."""
    return MemoryClient(
        api_url="http://localhost:8765",
        user_id="test_user"
    )

@pytest.mark.asyncio
async def test_memory_add_stores_conversation(memory_client):
    """Add operation stores conversation and extracts facts."""
    result = await memory_client.add(
        messages=[
            {"role": "user", "content": "My name is John and I love pizza"},
            {"role": "assistant", "content": "Nice to meet you, John!"}
        ]
    )
    assert result is not None
    assert "memory_id" in result or "memories" in result

@pytest.mark.asyncio
async def test_memory_search_finds_relevant(memory_client):
    """Search returns relevant memories for query."""
    # First add a memory
    await memory_client.add(
        messages=[
            {"role": "user", "content": "I'm allergic to shellfish"},
            {"role": "assistant", "content": "I'll remember that."}
        ]
    )

    # Search should find it
    results = await memory_client.search(
        query="What food allergies do I have?",
        limit=5
    )
    assert len(results) > 0
    assert any("shellfish" in str(r).lower() for r in results)

@pytest.mark.asyncio
async def test_memory_get_retrieves_by_id(memory_client):
    """Get retrieves specific memory by ID."""
    # Add and get ID
    add_result = await memory_client.add(
        messages=[{"role": "user", "content": "Test memory"}]
    )
    memory_id = add_result.get("memory_id") or add_result.get("memories", [{}])[0].get("id")

    # Retrieve by ID
    memory = await memory_client.get(memory_id)
    assert memory is not None

@pytest.mark.asyncio
async def test_memory_update_modifies_existing(memory_client):
    """Update modifies existing memory."""
    # Add initial memory
    add_result = await memory_client.add(
        messages=[{"role": "user", "content": "I like coffee"}]
    )
    memory_id = add_result.get("memory_id") or add_result.get("memories", [{}])[0].get("id")

    # Update it
    await memory_client.update(memory_id, "I prefer tea now")

    # Verify update
    memory = await memory_client.get(memory_id)
    assert "tea" in str(memory).lower()

@pytest.mark.asyncio
async def test_memory_delete_removes(memory_client):
    """Delete removes memory."""
    # Add memory
    add_result = await memory_client.add(
        messages=[{"role": "user", "content": "Temporary memory"}]
    )
    memory_id = add_result.get("memory_id") or add_result.get("memories", [{}])[0].get("id")

    # Delete it
    await memory_client.delete(memory_id)

    # Verify deleted
    memory = await memory_client.get(memory_id)
    assert memory is None

@pytest.mark.asyncio
async def test_memory_transparency_in_response(memory_client):
    """Memory client formats memories for transparency."""
    await memory_client.add(
        messages=[{"role": "user", "content": "My birthday is March 15"}]
    )

    results = await memory_client.search("birthday", limit=3)
    formatted = memory_client.format_for_prompt(results)

    assert "birthday" in formatted.lower()
    assert "march" in formatted.lower() or "15" in formatted
```

## Verification Command

```bash
pytest tests/test_memory.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M1.4 COMPLETE</promise>
```

## Dependencies

- M1.3 (Voice Loop) - for graceful shutdown integration

## Files to Create/Modify

- `backend/app/core/memory_client.py` - MemoryClient class
- `tests/test_memory.py`
