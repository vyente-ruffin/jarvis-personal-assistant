# M2.6 - Monitoring and Telemetry

## Task Description

**What**: Azure Application Insights integration for observability.

**Why**:
- Can't fix problems you can't see
- Performance issues need data to diagnose
- Usage patterns inform future development

## TDD Requirements

### Test File: `tests/test_monitoring.py`

Write these tests FIRST:

```python
import pytest
import io
import json
import logging

def test_logging_module_exists():
    """Structured logging module exists."""
    from app.core.logging import StructuredLogger

    logger = StructuredLogger("test")
    assert logger is not None

def test_structured_log_format():
    """Logs are structured JSON."""
    from app.core.logging import StructuredLogger

    # Capture log output
    stream = io.StringIO()
    handler = logging.StreamHandler(stream)

    logger = StructuredLogger("test")
    logger.logger.addHandler(handler)
    logger.log("info", "Test message", user_id="123")

    output = stream.getvalue()
    log_entry = json.loads(output)

    assert "timestamp" in log_entry
    assert "level" in log_entry
    assert "message" in log_entry
    assert log_entry["user_id"] == "123"

def test_app_insights_config_present():
    """Application Insights connection string in config."""
    from app.config import Settings

    settings = Settings()
    # Should have the field (even if empty in dev)
    assert hasattr(settings, "applicationinsights_connection_string")

def test_health_endpoint_logs_request():
    """Health endpoint request is logged."""
    from fastapi.testclient import TestClient
    from app.main import app

    client = TestClient(app)
    response = client.get("/health")

    assert response.status_code == 200
    # Logging happens internally - this just verifies no crash
```

## Verification Command

```bash
pytest tests/test_monitoring.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.6 COMPLETE</promise>
```

## Dependencies

- M2.4 (CI/CD Pipeline)

## Files to Create/Modify

- `backend/app/core/logging.py` - StructuredLogger class
- `backend/app/config.py` - Settings with App Insights config
- `tests/test_monitoring.py`
