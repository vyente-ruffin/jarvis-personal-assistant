# M4.4 - Calendar Integration

## Task Description

**What**: MCP server for reading and managing Google Calendar.

**Why**:
- "What's on my schedule?" is core assistant functionality
- Calendar context makes JARVIS more helpful
- Demonstrates OAuth integration pattern

## TDD Requirements

### Test File: `tests/test_calendar.py`

Write these tests FIRST (uses mock Google Calendar API):

```python
import pytest
from unittest.mock import patch, MagicMock
from datetime import datetime, timedelta

@pytest.fixture
def mock_calendar_service():
    """Mock Google Calendar service."""
    mock = MagicMock()

    # Mock events
    mock.events().list().execute.return_value = {
        "items": [
            {
                "id": "1",
                "summary": "Team Meeting",
                "start": {"dateTime": "2025-01-12T10:00:00Z"},
                "end": {"dateTime": "2025-01-12T11:00:00Z"}
            },
            {
                "id": "2",
                "summary": "Lunch with Bob",
                "start": {"dateTime": "2025-01-12T12:00:00Z"},
                "end": {"dateTime": "2025-01-12T13:00:00Z"}
            }
        ]
    }
    return mock

def test_calendar_list_events(mock_calendar_service):
    """Can list upcoming events."""
    from app.mcp.servers.google_calendar import GoogleCalendarMCP

    with patch("googleapiclient.discovery.build", return_value=mock_calendar_service):
        cal = GoogleCalendarMCP(credentials_path="test_creds.json")
        events = cal.list_events(days_ahead=7)

    assert len(events) == 2
    assert events[0]["summary"] == "Team Meeting"

def test_calendar_get_today(mock_calendar_service):
    """Can get today's events."""
    from app.mcp.servers.google_calendar import GoogleCalendarMCP

    with patch("googleapiclient.discovery.build", return_value=mock_calendar_service):
        cal = GoogleCalendarMCP(credentials_path="test_creds.json")
        events = cal.get_today()

    assert isinstance(events, list)

def test_calendar_create_event(mock_calendar_service):
    """Can create new event."""
    from app.mcp.servers.google_calendar import GoogleCalendarMCP

    mock_calendar_service.events().insert().execute.return_value = {"id": "new_event"}

    with patch("googleapiclient.discovery.build", return_value=mock_calendar_service):
        cal = GoogleCalendarMCP(credentials_path="test_creds.json")
        result = cal.create_event(
            summary="Doctor Appointment",
            start=datetime.now() + timedelta(days=1),
            duration_minutes=60
        )

    assert result["id"] == "new_event"
    mock_calendar_service.events().insert.assert_called()

def test_calendar_understands_relative_time():
    """Calendar understands relative time expressions."""
    from app.mcp.servers.google_calendar import GoogleCalendarMCP

    cal = GoogleCalendarMCP(credentials_path="test_creds.json")

    # "tomorrow at 3pm"
    dt = cal.parse_time("tomorrow at 3pm")
    assert dt.hour == 15
    assert dt.date() == (datetime.now() + timedelta(days=1)).date()

    # "next Monday"
    dt = cal.parse_time("next Monday")
    assert dt.weekday() == 0  # Monday

    # "in 2 hours"
    dt = cal.parse_time("in 2 hours")
    expected = datetime.now() + timedelta(hours=2)
    assert abs((dt - expected).total_seconds()) < 60

def test_calendar_formats_for_voice():
    """Calendar formats events for voice output."""
    from app.mcp.servers.google_calendar import GoogleCalendarMCP

    cal = GoogleCalendarMCP(credentials_path="test_creds.json")

    events = [
        {"summary": "Meeting", "start": {"dateTime": "2025-01-12T10:00:00Z"}}
    ]

    formatted = cal.format_for_voice(events)

    # Should be speakable
    assert "10" in formatted or "ten" in formatted.lower()
    assert "Meeting" in formatted

def test_calendar_provides_tool_schema():
    """Calendar MCP provides Gemini-compatible tool schema."""
    from app.mcp.servers.google_calendar import GoogleCalendarMCP

    cal = GoogleCalendarMCP(credentials_path="test_creds.json")
    schema = cal.get_tool_schema()

    tool_names = [t["name"] for t in schema]
    assert "list_events" in tool_names
    assert "create_event" in tool_names
    assert "get_today" in tool_names
```

## Verification Command

```bash
pytest tests/test_calendar.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M4.4 COMPLETE</promise>
```

## Dependencies

- M4.2 (Dynamic Tool Discovery)

## Files to Create/Modify

- `backend/app/mcp/servers/google_calendar.py` - GoogleCalendarMCP class
- `tests/test_calendar.py`
- `backend/requirements.txt` - Add google-api-python-client, google-auth dependencies
- `backend/app/mcp/servers/time_parser.py` - Natural language time parsing utility
