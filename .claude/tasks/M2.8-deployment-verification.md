# M2.8 - Deployment Verification

## Task Description

**What**: Smoke tests for deployed environment.

**Why**:
- Deployment isn't done until it's verified working
- Cloud environments differ from local
- Catches configuration and networking issues

## TDD Requirements

### Test File: `tests/test_deployment.py`

Write these tests FIRST (run AFTER deployment against live URL):

```python
import os
import pytest
import requests

PROD_URL = os.environ.get("JARVIS_PROD_URL", "https://jarvis-api.example.azurecontainerapps.io")

@pytest.mark.deployment
def test_production_health():
    """Production health endpoint responds."""
    response = requests.get(f"{PROD_URL}/health", timeout=10)
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

@pytest.mark.deployment
def test_production_readiness():
    """Production readiness check passes."""
    response = requests.get(f"{PROD_URL}/health/ready", timeout=10)
    assert response.status_code == 200

    data = response.json()
    assert data["status"] in ["ready", "degraded"]

@pytest.mark.deployment
def test_production_websocket_upgrade():
    """Production accepts WebSocket upgrade."""
    import websocket

    ws_url = PROD_URL.replace("https://", "wss://").replace("http://", "ws://")
    ws = websocket.create_connection(f"{ws_url}/ws/voice", timeout=10)

    try:
        ws.send('{"type": "ping"}')
        response = ws.recv()
        assert "pong" in response.lower()
    finally:
        ws.close()

@pytest.mark.deployment
def test_production_rejects_unauthorized_ip():
    """Production rejects requests from non-whitelisted IP."""
    # This test only makes sense from a non-whitelisted IP
    # Skip if running from the whitelisted IP
    pytest.skip("Run this from non-whitelisted IP to verify")
```

## Verification Command

```bash
JARVIS_PROD_URL=https://your-app.azurecontainerapps.io pytest tests/test_deployment.py -v -m deployment
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.8 COMPLETE</promise>
```

## Dependencies

- M2.4 (CI/CD Pipeline)
- M2.5 (Access Restriction)
- M2.6 (Monitoring)
- M2.7 (Health Checks)

## Files to Create/Modify

- `tests/test_deployment.py`
