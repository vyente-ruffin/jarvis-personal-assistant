# M4.1 - Plugin Manager

## Task Description

**What**: System for loading, configuring, and managing MCP server plugins.

**Why**:
- Standardized interface for adding capabilities
- Configuration-driven, not code-driven
- Can enable/disable plugins without redeployment

## TDD Requirements

### Test File: `tests/test_plugin_manager.py`

Write these tests FIRST:

```python
import pytest
from app.mcp.manager import MCPManager, MCPPlugin

@pytest.fixture
def mcp_manager():
    return MCPManager()

def test_plugin_loads_from_config(mcp_manager):
    """Plugin loads from configuration."""
    config = {
        "name": "test_plugin",
        "command": "echo",
        "args": ["hello"],
        "enabled": True
    }

    plugin = mcp_manager.load_plugin(config)

    assert plugin is not None
    assert plugin.name == "test_plugin"

def test_plugin_lists_tools(mcp_manager):
    """Loaded plugin exposes its tools."""
    config = {
        "name": "mock_plugin",
        "command": "python",
        "args": ["-m", "tests.mock_mcp_server"],
        "enabled": True
    }

    plugin = mcp_manager.load_plugin(config)
    tools = plugin.list_tools()

    assert isinstance(tools, list)

def test_plugin_enable_disable(mcp_manager):
    """Plugins can be enabled/disabled."""
    config = {
        "name": "toggleable",
        "command": "echo",
        "args": [],
        "enabled": True
    }

    plugin = mcp_manager.load_plugin(config)

    assert plugin.enabled == True

    mcp_manager.disable_plugin("toggleable")
    assert plugin.enabled == False

    mcp_manager.enable_plugin("toggleable")
    assert plugin.enabled == True

def test_disabled_plugin_not_called(mcp_manager):
    """Disabled plugins are not invoked."""
    config = {
        "name": "disabled_test",
        "command": "echo",
        "args": [],
        "enabled": False
    }

    plugin = mcp_manager.load_plugin(config)

    # Should not appear in active tools
    active_tools = mcp_manager.get_active_tools()

    disabled_tools = [t for t in active_tools if "disabled_test" in t.get("source", "")]
    assert len(disabled_tools) == 0

def test_plugin_failure_isolated(mcp_manager):
    """One plugin failing doesn't break others."""
    good_config = {"name": "good", "command": "echo", "args": [], "enabled": True}
    bad_config = {"name": "bad", "command": "nonexistent_command", "args": [], "enabled": True}

    mcp_manager.load_plugin(good_config)

    # Bad plugin should fail gracefully
    try:
        mcp_manager.load_plugin(bad_config)
    except:
        pass

    # Good plugin should still work
    assert "good" in [p.name for p in mcp_manager.plugins if p.enabled]
```

## Verification Command

```bash
pytest tests/test_plugin_manager.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M4.1 COMPLETE</promise>
```

## Dependencies

- M3.3 (Tool Integration)

## Files to Create/Modify

- `backend/app/mcp/__init__.py`
- `backend/app/mcp/manager.py` - MCPManager and MCPPlugin classes
- `tests/test_plugin_manager.py`
- `tests/mock_mcp_server.py` - Mock MCP server for testing
