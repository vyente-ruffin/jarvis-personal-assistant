# M3.4 - Memory Transparency

## Task Description

**What**: Clear communication of what JARVIS remembers and learns.

**Why**:
- Users need to trust the memory system
- Surprise memories feel creepy; acknowledged memories feel helpful
- Users should know how to correct wrong information

## TDD Requirements

### Test File: `tests/test_transparency.py`

Write these tests FIRST:

```python
import pytest
from app.core.memory_client import MemoryClient
from app.core.transparency import TransparencyFormatter

@pytest.fixture
def formatter():
    return TransparencyFormatter()

def test_memory_citation_in_response(formatter):
    """Responses cite which memories were used."""
    memories = [
        {"id": "1", "content": "User likes pizza"},
        {"id": "2", "content": "User is allergic to shellfish"}
    ]

    formatted = formatter.format_with_citations(
        response="Based on your preferences, how about pizza?",
        used_memories=memories
    )

    assert "Based on what I know" in formatted or "I remember" in formatted

def test_list_memories_command():
    """User can ask 'what do you know about me?'"""
    from app.core.conversation import handle_meta_command

    response = handle_meta_command("what do you know about me", user_id="test")

    assert response is not None
    # Should return list of memories or indicate none found

def test_correction_acknowledged():
    """Corrections are acknowledged in response."""
    formatter = TransparencyFormatter()

    response = formatter.format_correction(
        old_memory="User likes sushi",
        new_memory="User no longer likes sushi",
        acknowledged=True
    )

    assert "updated" in response.lower() or "noted" in response.lower()

def test_new_memory_announced():
    """New memories are announced when stored."""
    formatter = TransparencyFormatter()

    response = formatter.format_new_memory(
        memory_content="User's birthday is March 15"
    )

    assert "remember" in response.lower() or "noted" in response.lower()

def test_no_relevant_memories_handled():
    """Gracefully handles when no relevant memories found."""
    formatter = TransparencyFormatter()

    response = formatter.format_with_citations(
        response="I don't have any information about that.",
        used_memories=[]
    )

    # Should not crash or look weird
    assert len(response) > 0
    assert "Based on what I know" not in response  # Don't cite nothing
```

## Verification Command

```bash
pytest tests/test_transparency.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M3.4 COMPLETE</promise>
```

## Dependencies

- M3.2 (Web Agent)

## Files to Create/Modify

- `backend/app/core/transparency.py` - TransparencyFormatter class
- `backend/app/core/conversation.py` - handle_meta_command function
- `tests/test_transparency.py`
