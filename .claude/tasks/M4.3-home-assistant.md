# M4.3 - Home Assistant Integration

## Task Description

**What**: MCP server for controlling smart home via Home Assistant.

**Why**:
- "Turn off the lights" is iconic voice assistant functionality
- Home Assistant supports many devices
- Demonstrates extensibility

## TDD Requirements

### Test File: `tests/test_home_assistant.py`

Write these tests FIRST (uses mock Home Assistant for testing):

```python
import pytest
from unittest.mock import patch, MagicMock

@pytest.fixture
def mock_ha_client():
    """Mock Home Assistant client."""
    mock = MagicMock()
    mock.get_states.return_value = [
        {"entity_id": "light.living_room", "state": "on"},
        {"entity_id": "light.bedroom", "state": "off"},
        {"entity_id": "switch.fan", "state": "on"}
    ]
    return mock

def test_ha_list_devices(mock_ha_client):
    """Can list Home Assistant devices."""
    from app.mcp.servers.home_assistant import HomeAssistantMCP

    with patch("homeassistant_api.Client", return_value=mock_ha_client):
        ha = HomeAssistantMCP(url="http://localhost:8123", token="test")
        devices = ha.list_devices()

    assert len(devices) > 0
    assert any(d["entity_id"] == "light.living_room" for d in devices)

def test_ha_get_state(mock_ha_client):
    """Can get device state."""
    from app.mcp.servers.home_assistant import HomeAssistantMCP

    with patch("homeassistant_api.Client", return_value=mock_ha_client):
        ha = HomeAssistantMCP(url="http://localhost:8123", token="test")
        state = ha.get_state("light.living_room")

    assert state["state"] == "on"

def test_ha_turn_on(mock_ha_client):
    """Can turn on device."""
    from app.mcp.servers.home_assistant import HomeAssistantMCP

    with patch("homeassistant_api.Client", return_value=mock_ha_client):
        ha = HomeAssistantMCP(url="http://localhost:8123", token="test")
        result = ha.turn_on("light.bedroom")

    mock_ha_client.trigger_service.assert_called()
    assert result["success"] == True

def test_ha_turn_off(mock_ha_client):
    """Can turn off device."""
    from app.mcp.servers.home_assistant import HomeAssistantMCP

    with patch("homeassistant_api.Client", return_value=mock_ha_client):
        ha = HomeAssistantMCP(url="http://localhost:8123", token="test")
        result = ha.turn_off("light.living_room")

    mock_ha_client.trigger_service.assert_called()
    assert result["success"] == True

def test_ha_natural_language_mapping():
    """Natural language maps to correct device."""
    from app.mcp.servers.home_assistant import HomeAssistantMCP

    ha = HomeAssistantMCP(url="http://localhost:8123", token="test")

    # "living room lights" should map to light.living_room
    entity = ha.resolve_entity("living room lights")
    assert entity == "light.living_room"

    # "bedroom light" should map to light.bedroom
    entity = ha.resolve_entity("bedroom light")
    assert entity == "light.bedroom"

def test_ha_provides_tool_schema():
    """Home Assistant MCP provides Gemini-compatible tool schema."""
    from app.mcp.servers.home_assistant import HomeAssistantMCP

    ha = HomeAssistantMCP(url="http://localhost:8123", token="test")
    schema = ha.get_tool_schema()

    tool_names = [t["name"] for t in schema]
    assert "turn_on" in tool_names
    assert "turn_off" in tool_names
    assert "get_state" in tool_names
```

## Verification Command

```bash
pytest tests/test_home_assistant.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M4.3 COMPLETE</promise>
```

## Dependencies

- M4.2 (Dynamic Tool Discovery)

## Files to Create/Modify

- `backend/app/mcp/servers/__init__.py`
- `backend/app/mcp/servers/home_assistant.py` - HomeAssistantMCP class
- `tests/test_home_assistant.py`
- `backend/requirements.txt` - Add homeassistant-api dependency
