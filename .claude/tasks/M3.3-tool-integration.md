# M3.3 - Tool Integration

## Task Description

**What**: Framework for Gemini to invoke tools (vision, web, memory).

**Why**:
- Bridges natural language requests with concrete actions
- "Search for X" should trigger web agent automatically
- Extensible pattern for adding more tools

## TDD Requirements

### Test File: `tests/test_tools.py`

Write these tests FIRST:

```python
import pytest
from app.core.tool_manager import ToolManager, Tool

@pytest.fixture
def tool_manager():
    return ToolManager()

def test_tool_registration(tool_manager):
    """Tools can be registered."""
    def dummy_tool(query: str) -> str:
        return f"Result for {query}"

    tool_manager.register(
        name="dummy",
        description="A dummy tool",
        function=dummy_tool,
        parameters={"query": {"type": "string"}}
    )

    assert "dummy" in tool_manager.list_tools()

def test_tool_execution(tool_manager):
    """Registered tools can be executed."""
    def echo_tool(message: str) -> str:
        return message

    tool_manager.register(
        name="echo",
        description="Echo message",
        function=echo_tool,
        parameters={"message": {"type": "string"}}
    )

    result = tool_manager.execute("echo", {"message": "hello"})
    assert result == "hello"

def test_tool_schema_for_gemini(tool_manager):
    """Tool manager generates Gemini-compatible schema."""
    def search_tool(query: str) -> dict:
        return {"results": []}

    tool_manager.register(
        name="search",
        description="Search the web",
        function=search_tool,
        parameters={"query": {"type": "string", "description": "Search query"}}
    )

    schema = tool_manager.get_gemini_tools()

    assert len(schema) > 0
    assert schema[0]["name"] == "search"
    assert "parameters" in schema[0]

def test_tool_validation(tool_manager):
    """Tool validates parameters."""
    def typed_tool(count: int) -> int:
        return count * 2

    tool_manager.register(
        name="double",
        description="Double a number",
        function=typed_tool,
        parameters={"count": {"type": "integer"}}
    )

    # Valid call
    result = tool_manager.execute("double", {"count": 5})
    assert result == 10

    # Invalid call
    with pytest.raises(ValueError):
        tool_manager.execute("double", {"count": "not a number"})

def test_builtin_tools_registered(tool_manager):
    """Built-in tools (memory, search) are pre-registered."""
    tools = tool_manager.list_tools()

    # These should be available
    assert "memory_search" in tools or "search_memory" in tools
    assert "web_search" in tools or "search_web" in tools
```

## Verification Command

```bash
pytest tests/test_tools.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M3.3 COMPLETE</promise>
```

## Dependencies

- M3.2 (Web Agent)

## Files to Create/Modify

- `backend/app/core/tool_manager.py` - ToolManager class
- `tests/test_tools.py`
