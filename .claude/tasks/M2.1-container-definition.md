# M2.1 - Container Definition

## Task Description

**What**: Containerized backend application with all dependencies.

**Why**:
- Containers ensure identical environment in dev and prod
- Includes system dependencies (browsers for web agent)
- Portable across cloud providers

## TDD Requirements

### Test File: `tests/test_container.py`

Write these tests FIRST:

```python
import subprocess
import pytest
from pathlib import Path

def test_dockerfile_exists():
    """Dockerfile exists in backend directory."""
    assert Path("backend/Dockerfile").exists()

def test_docker_build_succeeds():
    """Docker image builds without errors."""
    result = subprocess.run(
        ["docker", "build", "-t", "jarvis-api:test", "./backend"],
        capture_output=True, text=True, timeout=300
    )
    assert result.returncode == 0, f"Build failed: {result.stderr}"

def test_container_starts():
    """Container starts and responds to health check."""
    # Start container
    subprocess.run(
        ["docker", "run", "-d", "--name", "jarvis-test", "-p", "8001:8000", "jarvis-api:test"],
        check=True
    )

    try:
        # Wait for startup
        import time
        time.sleep(5)

        # Check health
        import requests
        response = requests.get("http://localhost:8001/health", timeout=10)
        assert response.status_code == 200
    finally:
        subprocess.run(["docker", "rm", "-f", "jarvis-test"])

def test_container_includes_playwright():
    """Container has Playwright browsers installed."""
    result = subprocess.run(
        ["docker", "run", "--rm", "jarvis-api:test",
         "python", "-c", "from playwright.sync_api import sync_playwright; print('OK')"],
        capture_output=True, text=True
    )
    assert "OK" in result.stdout, f"Playwright not available: {result.stderr}"

def test_container_image_size_reasonable():
    """Container image is under 2GB."""
    result = subprocess.run(
        ["docker", "image", "inspect", "jarvis-api:test", "--format", "{{.Size}}"],
        capture_output=True, text=True
    )
    size_bytes = int(result.stdout.strip())
    size_gb = size_bytes / (1024**3)
    assert size_gb < 2.0, f"Image too large: {size_gb:.2f}GB"
```

## Verification Command

```bash
pytest tests/test_container.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.1 COMPLETE</promise>
```

## Dependencies

- M1.1 (Project Structure)

## Files to Create/Modify

- `backend/Dockerfile`
- `tests/test_container.py`
