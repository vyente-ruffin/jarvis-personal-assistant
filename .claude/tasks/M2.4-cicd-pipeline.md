# M2.4 - Automated Deployment Pipeline

## Task Description

**What**: GitHub Actions workflow for CI/CD.

**Why**:
- Manual deployments are error-prone and slow
- Automated testing catches issues before production
- Push-to-deploy reduces friction

## TDD Requirements

### Test File: `tests/test_cicd.py`

Write these tests FIRST:

```python
import yaml
from pathlib import Path

def test_github_workflow_exists():
    """GitHub Actions workflow file exists."""
    workflow = Path(".github/workflows/deploy.yml")
    assert workflow.exists()

def test_workflow_yaml_valid():
    """Workflow YAML is valid."""
    with open(".github/workflows/deploy.yml") as f:
        workflow = yaml.safe_load(f)

    assert workflow is not None
    assert "jobs" in workflow

def test_workflow_triggers_on_main():
    """Workflow triggers on push to main."""
    with open(".github/workflows/deploy.yml") as f:
        workflow = yaml.safe_load(f)

    on_config = workflow.get("on", {})
    push_config = on_config.get("push", {})
    branches = push_config.get("branches", [])

    assert "main" in branches

def test_workflow_runs_tests():
    """Workflow includes test step."""
    with open(".github/workflows/deploy.yml") as f:
        workflow = yaml.safe_load(f)

    # Find any step that runs tests
    all_steps = []
    for job in workflow.get("jobs", {}).values():
        all_steps.extend(job.get("steps", []))

    test_steps = [
        s for s in all_steps
        if "pytest" in str(s.get("run", "")).lower() or
           "test" in str(s.get("name", "")).lower()
    ]
    assert len(test_steps) > 0, "No test step found"

def test_workflow_deploys_conditionally():
    """Deployment only runs on main branch."""
    with open(".github/workflows/deploy.yml") as f:
        workflow = yaml.safe_load(f)

    # Find deploy steps
    for job in workflow.get("jobs", {}).values():
        for step in job.get("steps", []):
            if "deploy" in str(step.get("name", "")).lower():
                # Should have a condition
                assert step.get("if") is not None, f"Deploy step has no condition: {step}"
```

## Verification Command

```bash
pytest tests/test_cicd.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.4 COMPLETE</promise>
```

## Dependencies

- M2.3 (Frontend Hosting)

## Files to Create/Modify

- `.github/workflows/deploy.yml`
- `tests/test_cicd.py`
