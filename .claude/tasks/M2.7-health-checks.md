# M2.7 - Health Checks

## Task Description

**What**: Liveness and readiness probes for container orchestration.

**Why**:
- Azure needs to know if container is healthy
- Enables automatic restart on failure
- Distinguishes "starting up" from "broken"

## TDD Requirements

### Test File: `tests/test_health.py`

Write these tests FIRST:

```python
from fastapi.testclient import TestClient
from app.main import app
import pytest

def test_liveness_endpoint_exists():
    """Liveness probe endpoint exists."""
    client = TestClient(app)
    response = client.get("/health")

    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_readiness_endpoint_exists():
    """Readiness probe endpoint exists."""
    client = TestClient(app)
    response = client.get("/health/ready")

    assert response.status_code == 200
    data = response.json()
    assert "status" in data
    assert "checks" in data

def test_readiness_reports_dependencies():
    """Readiness check reports dependency status."""
    client = TestClient(app)
    response = client.get("/health/ready")

    checks = response.json()["checks"]

    # Should check these dependencies
    assert "gemini" in checks or "memory" in checks

def test_readiness_degrades_gracefully():
    """Readiness returns degraded when dependency down."""
    # This would require mocking a dependency failure
    # For now, just verify the endpoint structure
    client = TestClient(app)
    response = client.get("/health/ready")

    data = response.json()
    assert data["status"] in ["ready", "degraded", "unhealthy"]

def test_health_includes_timestamp():
    """Health responses include timestamp."""
    client = TestClient(app)
    response = client.get("/health")

    data = response.json()
    assert "timestamp" in data
```

## Verification Command

```bash
pytest tests/test_health.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.7 COMPLETE</promise>
```

## Dependencies

- M2.4 (CI/CD Pipeline)

## Files to Create/Modify

- Update `backend/app/main.py` with health endpoints
- `backend/app/routes/health.py` - Health check routes
- `tests/test_health.py`
