# M3.1 - Vision API

## Task Description

**What**: Endpoint that accepts images and returns understanding/analysis.

**Why**:
- Enables smart glasses integration
- Supports "what is this?" queries with camera
- Foundation for visual context

## TDD Requirements

### Test File: `tests/test_vision.py`

Write these tests FIRST:

```python
from fastapi.testclient import TestClient
from app.main import app
import io
from PIL import Image
import time

def create_test_image():
    """Create a simple test image."""
    img = Image.new('RGB', (100, 100), color='red')
    buffer = io.BytesIO()
    img.save(buffer, format='PNG')
    buffer.seek(0)
    return buffer

def test_vision_endpoint_exists():
    """Vision API endpoint exists."""
    client = TestClient(app)

    response = client.post(
        "/api/vision/analyze",
        files={"image": ("test.png", create_test_image(), "image/png")}
    )

    # Should not be 404
    assert response.status_code != 404

def test_vision_accepts_image_upload():
    """Vision API accepts image upload."""
    client = TestClient(app)

    response = client.post(
        "/api/vision/analyze",
        files={"image": ("test.png", create_test_image(), "image/png")},
        data={"prompt": "What color is this image?"}
    )

    assert response.status_code == 200

def test_vision_returns_analysis():
    """Vision API returns analysis."""
    client = TestClient(app)

    response = client.post(
        "/api/vision/analyze",
        files={"image": ("test.png", create_test_image(), "image/png")},
        data={"prompt": "Describe this image"}
    )

    data = response.json()
    assert "analysis" in data
    assert len(data["analysis"]) > 0

def test_vision_validates_file_type():
    """Vision API rejects non-image files."""
    client = TestClient(app)

    response = client.post(
        "/api/vision/analyze",
        files={"image": ("test.txt", b"not an image", "text/plain")}
    )

    assert response.status_code == 400

def test_vision_response_time():
    """Vision API responds within 5 seconds."""
    client = TestClient(app)

    start = time.time()
    response = client.post(
        "/api/vision/analyze",
        files={"image": ("test.png", create_test_image(), "image/png")},
        data={"prompt": "Quick description"}
    )
    elapsed = time.time() - start

    assert response.status_code == 200
    assert elapsed < 5.0, f"Response too slow: {elapsed:.2f}s"
```

## Verification Command

```bash
pytest tests/test_vision.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M3.1 COMPLETE</promise>
```

## Dependencies

- M2.2 (Backend Infrastructure)

## Files to Create/Modify

- `backend/app/routes/vision.py` - Vision API endpoint
- `backend/app/core/vision_analyzer.py` - Vision analysis logic
- `tests/test_vision.py`
