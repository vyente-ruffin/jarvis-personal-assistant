# M2.5 - Access Restriction

## Task Description

**What**: IP whitelist to restrict access to owner only.

**Why**:
- POC doesn't need full authentication
- Prevents unauthorized access during development
- Simple to implement and change

## TDD Requirements

### Test File: `tests/test_security.py`

Write these tests FIRST:

```python
import yaml

def test_ip_restrictions_configured():
    """IP security restrictions are configured."""
    with open("azure/jarvis-api.yaml") as f:
        config = yaml.safe_load(f)

    ingress = config["properties"]["configuration"]["ingress"]
    restrictions = ingress.get("ipSecurityRestrictions", [])

    assert len(restrictions) > 0, "No IP restrictions configured"

def test_default_deny_rule_exists():
    """Default deny-all rule exists."""
    with open("azure/jarvis-api.yaml") as f:
        config = yaml.safe_load(f)

    ingress = config["properties"]["configuration"]["ingress"]
    restrictions = ingress.get("ipSecurityRestrictions", [])

    deny_rules = [r for r in restrictions if r.get("action") == "Deny"]
    assert len(deny_rules) > 0, "No deny rule found"

    # Should deny all by default
    deny_all = any(
        r.get("ipAddressRange") == "0.0.0.0/0"
        for r in deny_rules
    )
    assert deny_all, "No deny-all rule (0.0.0.0/0)"

def test_allow_rule_is_specific():
    """Allow rule is specific IP, not wide range."""
    with open("azure/jarvis-api.yaml") as f:
        config = yaml.safe_load(f)

    ingress = config["properties"]["configuration"]["ingress"]
    restrictions = ingress.get("ipSecurityRestrictions", [])

    allow_rules = [r for r in restrictions if r.get("action") == "Allow"]

    for rule in allow_rules:
        ip_range = rule.get("ipAddressRange", "")
        # Should be /32 (single IP) or at most /24
        if "/" in ip_range:
            prefix = int(ip_range.split("/")[1])
            assert prefix >= 24, f"IP range too wide: {ip_range}"
```

## Verification Command

```bash
pytest tests/test_security.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.5 COMPLETE</promise>
```

## Dependencies

- M2.4 (CI/CD Pipeline)

## Files to Create/Modify

- Update `azure/jarvis-api.yaml` with IP restrictions
- `tests/test_security.py`
