# M4.2 - Dynamic Tool Discovery

## Task Description

**What**: Automatic registration of tools from loaded MCP servers.

**Why**:
- New plugin = new tools, automatically
- No manual registration or code changes
- Tools self-describe their capabilities

## TDD Requirements

### Test File: `tests/test_tool_discovery.py`

Write these tests FIRST:

```python
import pytest
from app.mcp.manager import MCPManager
from app.core.tool_manager import ToolManager

@pytest.fixture
def integrated_system():
    mcp_manager = MCPManager()
    tool_manager = ToolManager()
    tool_manager.register_mcp_manager(mcp_manager)
    return mcp_manager, tool_manager

def test_mcp_tools_auto_registered(integrated_system):
    """MCP tools are automatically registered."""
    mcp_manager, tool_manager = integrated_system

    # Load a mock MCP server with known tools
    mcp_manager.load_plugin({
        "name": "mock",
        "command": "python",
        "args": ["-m", "tests.mock_mcp_server"],
        "enabled": True
    })

    # Tools should now be available
    tools = tool_manager.list_tools()

    assert any("mock" in t for t in tools)

def test_tool_schema_includes_mcp_tools(integrated_system):
    """Gemini tool schema includes MCP tools."""
    mcp_manager, tool_manager = integrated_system

    mcp_manager.load_plugin({
        "name": "calculator",
        "command": "python",
        "args": ["-m", "tests.mock_calculator_mcp"],
        "enabled": True
    })

    schema = tool_manager.get_gemini_tools()

    # Should include calculator tools
    tool_names = [t["name"] for t in schema]
    assert "add" in tool_names or "calculate" in tool_names

def test_disabled_mcp_tools_not_in_schema(integrated_system):
    """Disabled MCP plugins don't appear in tool schema."""
    mcp_manager, tool_manager = integrated_system

    mcp_manager.load_plugin({
        "name": "disabled_calc",
        "command": "python",
        "args": ["-m", "tests.mock_calculator_mcp"],
        "enabled": False
    })

    schema = tool_manager.get_gemini_tools()

    # Should NOT include disabled plugin's tools
    for tool in schema:
        assert "disabled_calc" not in tool.get("source", "")

def test_mcp_tool_execution(integrated_system):
    """MCP tools can be executed through tool manager."""
    mcp_manager, tool_manager = integrated_system

    mcp_manager.load_plugin({
        "name": "echo_mcp",
        "command": "python",
        "args": ["-m", "tests.mock_echo_mcp"],
        "enabled": True
    })

    result = tool_manager.execute("echo", {"message": "test"})

    assert result == "test"

def test_tool_discovery_refreshes(integrated_system):
    """Tool list updates when plugins change."""
    mcp_manager, tool_manager = integrated_system

    initial_count = len(tool_manager.list_tools())

    mcp_manager.load_plugin({
        "name": "new_plugin",
        "command": "python",
        "args": ["-m", "tests.mock_mcp_server"],
        "enabled": True
    })

    new_count = len(tool_manager.list_tools())

    assert new_count > initial_count
```

## Verification Command

```bash
pytest tests/test_tool_discovery.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M4.2 COMPLETE</promise>
```

## Dependencies

- M4.1 (Plugin Manager)
- M3.3 (Tool Integration)

## Files to Create/Modify

- `backend/app/core/tool_manager.py` - Add register_mcp_manager method
- `backend/app/mcp/manager.py` - Add tool discovery hooks
- `tests/test_tool_discovery.py`
- `tests/mock_calculator_mcp.py` - Mock calculator MCP server
- `tests/mock_echo_mcp.py` - Mock echo MCP server
