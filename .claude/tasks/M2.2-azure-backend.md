# M2.2 - Backend Infrastructure

## Task Description

**What**: Azure Container Apps configuration for running the backend.

**Why**:
- Infrastructure-as-code enables reproducible deployments
- Version controlled = auditable changes
- Supports WebSocket connections

## TDD Requirements

### Test File: `tests/test_azure_config.py`

Write these tests FIRST:

```python
import yaml
import subprocess
import pytest
from pathlib import Path

def test_container_apps_yaml_valid():
    """Container Apps YAML is valid."""
    config_path = Path("azure/jarvis-api.yaml")
    assert config_path.exists()

    with open(config_path) as f:
        config = yaml.safe_load(f)

    assert config is not None

def test_container_apps_has_required_fields():
    """Container Apps config has required fields."""
    with open("azure/jarvis-api.yaml") as f:
        config = yaml.safe_load(f)

    # Required for WebSocket support
    assert "properties" in config
    props = config["properties"]

    assert "configuration" in props
    assert "ingress" in props["configuration"]

    ingress = props["configuration"]["ingress"]
    assert ingress.get("transport") == "http"  # Required for WebSocket
    assert ingress.get("targetPort") == 8000

def test_container_apps_has_health_probes():
    """Health probes configured for WebSocket."""
    with open("azure/jarvis-api.yaml") as f:
        config = yaml.safe_load(f)

    template = config["properties"]["template"]
    containers = template["containers"]

    # At least one container should have probes
    has_probes = any(
        "probes" in c or "livenessProbe" in c or "readinessProbe" in c
        for c in containers
    )
    assert has_probes, "No health probes configured"

def test_container_apps_min_replicas():
    """Min replicas >= 1 for WebSocket."""
    with open("azure/jarvis-api.yaml") as f:
        config = yaml.safe_load(f)

    scale = config["properties"]["template"].get("scale", {})
    min_replicas = scale.get("minReplicas", 0)

    # WebSocket needs at least 1 replica always running
    assert min_replicas >= 1, "Min replicas must be >= 1 for WebSocket"

def test_azure_cli_validates_config():
    """Azure CLI can validate the configuration."""
    result = subprocess.run(
        ["az", "containerapp", "create", "--help"],
        capture_output=True, text=True
    )
    # Just verify Azure CLI is available
    assert result.returncode == 0 or "az login" in result.stderr.lower()
```

## Verification Command

```bash
pytest tests/test_azure_config.py -v
```

## Completion Promise

Only output this when ALL tests pass:

```
<promise>M2.2 COMPLETE</promise>
```

## Dependencies

- M2.1 (Container Definition)

## Files to Create/Modify

- `azure/jarvis-api.yaml` - Container Apps configuration
- `tests/test_azure_config.py`
